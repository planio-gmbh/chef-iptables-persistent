<%- extend IptablesPersistent::TemplateHelpers -%>
# Firewall Rules for <%= @protocol %>
#
# This script was automatically created by Chef.
# All manual changes are going to be overridden
#
# Source: iptables-persistent::templates/default/rules.erb

*filter
<% defaults, default_rules = node["iptables-persistent"][@protocol]["chains"].sort.partition{|default| %w[ACCEPT DROP -].include? default[1]} -%>
<% defaults.each do |chain, default| -%>
:<%= chain %> <%= default %> [0:0]
<%- end %>
<% default_rules.each do |chain, default| -%>
:<%= chain %> ACCEPT [0:0] # final rule: <%= default %>
<%- end %>

<% rules(@protocol).each do |rule| -%>
<%= rule %>
<%- end %>

<%- if default_rules.any? %>### DEFAULT RULES<% end %>
<% default_rules.each do |chain, default| -%>
-A <%= chain %> -j <%= default %>
<%- end %>

COMMIT

<% if @protocol == "ipv4" && (nat = nat_rules("ipv4")).any? %>
*nat
<% nat.each do |rule| -%>
<%= rule %>
<%- end %>

COMMIT
<% end %>
